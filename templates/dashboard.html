{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Confident Moves Intervention - Dashboard</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2rem;
            font-weight: 300;
        }
        .user-info {
            text-align: right;
            color: #666;
        }
        .logout-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card h2 {
            color: #333;
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 400;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }
        .card h3 {
            color: #555;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 500;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .status-item {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .status-item h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
        }
        .status-item p {
            margin: 0;
            color: #666;
        }
        .alert {
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }
        .alert-info {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #0d47a1;
        }
        .alert-warning {
            background: #fff3e0;
            border-left-color: #ff9800;
            color: #e65100;
        }
        .alert-success {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        .alert-secondary {
            background: #f5f5f5;
            border-left-color: #9e9e9e;
            color: #424242;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        .btn-large {
            padding: 20px 40px;
            font-size: 1.3rem;
            font-weight: 700;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            max-width: 500px;
            margin: 1rem auto;
            border-radius: 15px;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 1rem 0;
            overflow: hidden;
        }
        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .messages {
            margin-bottom: 2rem;
        }
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #e3f2fd;
            color: #0d47a1;
            border-left: 4px solid #2196f3;
        }
        .footer {
            text-align: center;
            color: white;
            margin-top: 3rem;
            padding: 2rem;
        }
        .footer p {
            margin: 0.5rem 0;
            opacity: 0.9;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            margin-top: 1rem;
        }
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            .user-info {
                text-align: center;
            }
            .status-grid {
                grid-template-columns: 1fr;
            }
            .card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Confident Moves Intervention Dashboard</h1>
                <p style="margin: 0.5rem 0 0 0; color: #666;">Welcome back, {{ user.username }}!</p>
            </div>
            <div class="user-info">
                <p style="margin: 0 0 0.5rem 0;"><strong>Study Day:</strong> {{ study_day|default:"N/A" }}</p>
                <a href="{% url 'logout' %}" class="logout-btn">Sign Out</a>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="message">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Enrollment Status -->
        {% if needs_consent %}
            <div class="card">
                <div class="alert alert-warning">
                    <h3>📋 Enrollment Status: Eligible - Pending Consent</h3>
                    <p>Congratulations! You have been found eligible for the study. To complete your enrollment, please provide your consent.</p>
                    <a href="{% url 'consent_form' %}" class="btn btn-primary">Complete Consent Form</a>
                </div>
            </div>
        {% elif progress and progress.eligible and progress.consent_given and participant %}
            <!-- Study Progress Card -->
            <div class="card">
                <h2>📊 Study Progress</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <h4>Enrollment Status</h4>
                        <p style="color: #4caf50; font-weight: 600;">✅ Fully Enrolled</p>
                    </div>
                    <div class="status-item">
                        <h4>Intervention Points</h4>
                        <p style="color: #ff6b35; font-weight: 600; font-size: 1.2em;">🎯 {{ intervention_points|default:0 }} points</p>
                    </div>
                    <div class="status-item">
                        <h4>Study Day</h4>
                        <p><strong>{{ study_day|default:"N/A" }}</strong> of 113 days</p>
                    </div>
                    <div class="status-item">
                        <h4>Progress</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ progress_percentage|default:"0" }}%;"></div>
                        </div>
                        <p>{{ progress_percentage|default:"0" }}% Complete</p>
                    </div>
                    <div class="status-item">
                        <h4>Participant ID</h4>
                        <p><strong>{{ participant.participant_id }}</strong></p>
                    </div>
                </div>
            </div>

            <!-- Wave 1 Online Survey (Days 1-7) -->
            {% if show_wave1_survey %}
                <div class="card">
                    <div class="alert alert-success">
                        <h3>🎉 Wave 1 Online Survey</h3>
                        <p><strong>Hi {{ participant.participant_id }},</strong></p>
                        <p>Congratulations! You are now enrolled as a participant in the study.</p>
                        <p>Please click the button below to complete your task, Survey 1, within 7 days to receive a $5 Amazon gift card. We highly recommend completing it as soon as possible before the link expires. You may need to remember your ID from this website and enter it to complete the survey. Your ID is: <strong>{{ participant.participant_id }}</strong></p>
                        
                        {% if wave1_survey_content %}
                            <div style="margin: 1rem 0;">
                                {{ wave1_survey_content.content|safe }}
                            </div>
                        {% else %}
                            <p><strong>Link:</strong> TBD</p>
                        {% endif %}
                        
                        <p style="margin-top: 1rem;">If you need any assistance or have any questions at any time, please contact Seungmin ("Seung") Lee (Principal Investigator) at <a href="mailto:svu23@iastate.edu">svu23@iastate.edu</a> or <a href="tel:517-898-0020">517-898-0020</a>.</p>
                        <p><strong>Sincerely,</strong><br>The Confident Moves Research Team</p>
                    </div>
                </div>
            {% endif %}

            <!-- Intervention Access Buttons -->
            <div class="card">
                <div class="alert alert-info">
                    <h3>🎯 Intervention</h3>
                    <a href="{% url 'intervention_access' %}" class="btn btn-primary btn-large">Open Intervention</a>
                    {% if show_test_intervention_button and request.user.is_staff %}
                        <a href="{% url 'intervention_access_test' %}" class="btn btn-primary btn-large">Open Test Intervention</a>
                    {% endif %}
                </div>
            </div>

            <!-- Wave 1 Code Entry -->
            {% if progress.day_1 %}
                {% if within_wave1_period %}
                    <div class="card">
                        <div class="alert alert-info">
                            <h3>📱 Wave 1 Physical Activity Code Entry</h3>
                            <p>You need to enter a code on the website within 14 days to complete the physical activity monitoring. The code can be found in the mail package that will arrive at your address (the one you provided) in a few days.</p>
                            <p>• Please enter the code:</p>
                            <form method="POST" action="{% url 'enter_code' wave=1 %}">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="code">Code:</label>
                                    <input type="text" id="code" name="code" required placeholder="Enter your code">
                                </div>
                                <button type="submit" class="btn btn-primary">Submit Code</button>
                            </form>
                            {% if code_error %}
                                <p style="color: #dc3545; margin-top: 1rem;">{{ code_error }}</p>
                            {% endif %}
                            <p style="margin-top: 1rem; font-style: italic; color: #666;">If you need any assistance, contact Seungmin Lee at svu23@iastate.edu or 517-898-0020.</p>
                        </div>
                    </div>
                {% elif study_day < 8 %}
                    <div class="card">
                        <div class="alert alert-warning">
                            <h3>⏳ Wave 1 Code Entry</h3>
                            <p>Wave 1 code entry opens on <strong>{{ start_date_wave1 }}</strong> ({{ days_until_start_wave1 }} days from today).</p>
                        </div>
                    </div>
                {% elif study_day > 21 or participant.code_entered %}
                    <div class="card">
                        <div class="alert alert-secondary">
                            <h3>✅ Wave 1 Code Entry</h3>
                            {% if participant.code_entered %}
                                <p>Code entry completed on {{ participant.code_entry_date|date:"Y-m-d" }}.</p>
                            {% else %}
                                <p>The Wave 1 code entry period has ended.</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            <!-- Wave 3 Code Entry -->
            {% if progress.day_1 %}
                {% if within_wave3_period %}
                    <div class="card">
                        <div class="alert alert-info">
                            <h3>📱 Wave 3 Physical Activity Code Entry</h3>
                            <p>You will receive a code to wear the physical activity monitor when you get the device.</p>
                            <p>Please enter the code below:</p>
                            <form method="POST" action="{% url 'enter_code' wave=3 %}">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="code">Code:</label>
                                    <input type="text" id="code" name="code" required placeholder="Enter your code">
                                </div>
                                <button type="submit" class="btn btn-primary">Submit Code</button>
                            </form>
                            {% if code_error %}
                                <p style="color: #dc3545; margin-top: 1rem;">{{ code_error }}</p>
                            {% endif %}
                            <p style="margin-top: 1rem; font-style: italic; color: #666;">If you need any assistance, contact Seungmin Lee at svu23@iastate.edu or 517-898-0020.</p>
                        </div>
                    </div>
                {% elif study_day < 95 %}
                    <div class="card">
                        <div class="alert alert-warning">
                            <h3>⏳ Wave 3 Code Entry</h3>
                            <p>Wave 3 code entry opens on <strong>{{ start_date_wave3 }}</strong> ({{ days_until_start_wave3 }} days from today).</p>
                        </div>
                    </div>
                {% elif study_day > 104 or participant.wave3_code_entered %}
                    <div class="card">
                        <div class="alert alert-secondary">
                            <h3>✅ Wave 3 Code Entry</h3>
                            <p>The Wave 3 code entry period has ended.</p>
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            <!-- Intervention Access -->
            {% if participant and participant.randomized_group == 1 and 29 <= study_day and study_day <= 56 %}
                <div class="card">
                    <div class="alert alert-success">
                        <h3>🎯 Intervention Access Available</h3>
                        <p>You now have access to the physical activity intervention (Days 29-56).</p>
                        <a href="{% url 'intervention_access' %}" class="btn btn-success">Access Intervention</a>
                    </div>
                </div>
            {% elif participant and participant.randomized_group == 0 and study_day > 112 %}
                <div class="card">
                    <div class="alert alert-success">
                        <h3>🎯 Intervention Access Available</h3>
                        <p>You now have access to the physical activity intervention after study completion.</p>
                        <a href="{% url 'intervention_access' %}" class="btn btn-success">Access Intervention</a>
                    </div>
                </div>
            {% endif %}

        {% else %}
            <!-- Not Enrolled -->
            <div class="card">
                <div class="alert alert-warning">
                    <h3>📝 Complete Enrollment</h3>
                    <p>Please complete enrollment to view study progress.</p>
                    {% if not progress %}
                        <a href="{% url 'questionnaire' %}" class="btn btn-primary">Complete Eligibility Questionnaire</a>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Contact Information -->
        <div class="card">
            <h2>📞 Need Help?</h2>
            <p>If you need assistance, contact Seungmin Lee at <strong>svu23@iastate.edu</strong> or <strong>517-898-0020</strong>.</p>
        </div>

    </div>

    <div class="footer">
        <p>&copy; Confident Moves Intervention. All rights reserved.</p>
    </div>
</body>
</html>